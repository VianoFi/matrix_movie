@model matrix_movie.Models.Movie
@{
    ViewData["Title"] = Model.Title;
}
@Html.AntiForgeryToken()

<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

<div class="container-fluid matrix-bg py-5 text-center">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <img src="@Model.ImageUrl" alt="@Model.Title" class="img-fluid movie-detail-img" />
        </div>
        <div class="col-md-6 text-start mt-4 mt-md-0">
            <h1 class="matrix-title">@Model.Title</h1>
            <p><strong>Genere:</strong> @Model.Genre</p>
            <p><strong>Anno:</strong> @Model.Year</p>
            <hr style="border-color:#39FF14;">
            <h5>Descrizione</h5>
            <p>@Model.Description</p>
            <h5>Trama</h5>
            <p>@Model.Plot</p>

            <div class="mt-4 d-flex flex-wrap gap-2">
                <a asp-controller="Home" asp-action="Index" class="btn-matrix">⬅ Torna ai film</a>

                @if (User.Identity.IsAuthenticated && !User.IsInRole("Admin"))
                {
                    if (ViewBag.IsWatched == true)
                    {
                        <button class="btn-matrix watched" disabled>✔ Già visto</button>
                    }
                    else
                    {
                        <button class="btn-matrix add" id="addWatchedBtn"
                                type="button"
                                data-movie-id="@Model.Id">
                            ➕ Aggiungi ai visti
                        </button>
                    }

                    <button class="btn-matrix cart" id="addCartBtn"
                            type="button"
                            data-movie-id="@Model.Id">
                        🛒 Aggiungi al carrello
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modale per aggiungere ai visti -->
<div class="modal fade" id="addWatchedModal" tabindex="-1" aria-labelledby="addWatchedModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color:#0d0d0d; border:1px solid #39FF14; color:#39FF14;">
            <div class="modal-header">
                <h5 class="modal-title">🎥 Segna come visto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="movieId" value="@Model.Id" />
                <div class="mb-3">
                    <label for="watchDate" class="form-label">Data di visione</label>
                    <input type="date" id="watchDate" class="form-control bg-dark text-light border-success" />
                </div>
                <div class="mb-3">
                    <label for="comment" class="form-label">Commento personale</label>
                    <textarea id="comment" class="form-control bg-dark text-light border-success" rows="3" maxlength="300"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="saveWatchedBtn">💾 Salva</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        body {
            background: #000;
            color: #39FF14;
            font-family: 'Share Tech Mono', monospace;
        }

        .matrix-title {
            text-shadow: 0 0 10px #39FF14;
            color: #39FF14;
        }

        .movie-detail-img {
            border: 2px solid #39FF14;
            box-shadow: 0 0 20px #39FF14;
            border-radius: 10px;
            transition: transform .3s;
        }

            .movie-detail-img:hover {
                transform: scale(1.02);
            }

        .btn-matrix {
            border: 1px solid #39FF14;
            color: #39FF14;
            background: transparent;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all .3s;
            text-decoration: none;
        }

            .btn-matrix:hover {
                background: #39FF14;
                color: #000;
                box-shadow: 0 0 10px #39FF14;
            }

            .btn-matrix.watched {
                border-color: #888;
                color: #888;
                background: #111;
                cursor: not-allowed;
                box-shadow: none;
            }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const addBtn = document.getElementById('addWatchedBtn');
            const saveBtn = document.getElementById('saveWatchedBtn');
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    const dateInput = document.getElementById('watchDate');
                    if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
                    new bootstrap.Modal(document.getElementById('addWatchedModal')).show();
                });
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    const id = document.getElementById('movieId').value;
                    const date = document.getElementById('watchDate').value;
                    const comment = document.getElementById('comment').value;

                    fetch('@Url.Action("SegnaComeVisto", "Home")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `__RequestVerificationToken=${encodeURIComponent(token)}&id=${encodeURIComponent(id)}&watchDate=${encodeURIComponent(date)}&comment=${encodeURIComponent(comment)}`
                    })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            bootstrap.Modal.getInstance(document.getElementById('addWatchedModal')).hide();
                            window.location.href = '/Home/Visti';
                        } else {
                            alert('❌ Errore: ' + (d.message || 'Salvataggio non riuscito.'));
                        }
                    })
                    .catch(() => alert('❌ Errore di rete — token mancante o richiesta rifiutata.'));
                });
            }

            const addCartBtn = document.getElementById('addCartBtn');
            if (addCartBtn) {
                addCartBtn.addEventListener('click', () => {
                    const id = addCartBtn.getAttribute('data-movie-id');
                    fetch('/Carrello/Aggiungi', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'id=' + encodeURIComponent(id)
                    })
                    .then(r => r.json())
                    .then(d => {
                        if (d.success) {
                            document.getElementById('cart-count').textContent = d.count;
                            addCartBtn.textContent = '✔️ Aggiunto';
                            addCartBtn.disabled = true;
                        }
                    });
                });
            }
        });
    </script>
}
